{% extends "shop/base.html" %}
{% load static money i18n humanize l10n %}
{% block title %}Ödeme{% endblock %}

{% block content %}
  <div class="container section">
    <div class="stepper mb-4">
      <div class="step is-past"><label>Sepet</label></div>
      <div class="step is-current"><label>Bilgiler</label></div>
      <div class="step"><label>Ödeme</label></div>
    </div>
  </div>

  <nav class="checkout-steps" aria-label="Ödeme Adımları">
    <div class="step active"><span class="dot"></span> Sepet</div>
    <div class="step active"><span class="dot"></span> Adres & Kargo</div>
    <div class="step"><span class="dot"></span> Ödeme</div>
    <div class="step"><span class="dot"></span> Onay</div>
  </nav>
  <div class="container py-4">
    <div class="row g-4">
      <!-- Sol: form alanları -->
      <div class="col-lg-7">
        <form id="checkout-form" method="post" action="{% url 'shop:checkout_pay' %}">
          {% csrf_token %}
          
          {% if form.non_field_errors %}
            <div class="alert alert-danger">
              {{ form.non_field_errors }}
            </div>
          {% endif %}
          
          <!-- Adres Seçimi (Giriş yapmış kullanıcılar için) -->
          {% if user.is_authenticated %}
            <div class="card mb-4">
              <div class="card-header">
                <h5 class="mb-0">Teslimat Adresi</h5>
              </div>
              <div class="card-body">
                {% if user_addresses %}
                  <div class="form-group mb-3">
                    <label class="form-label">Kayıtlı Adresleriniz</label>
                    <select class="form-select" id="address-select" name="selected_address">
                      <option value="">Yeni adres gir</option>
                      {% for address in user_addresses %}
                        <option value="{{ address.id }}" {% if address.is_default %}selected{% endif %}
                                data-fullname="{{ address.fullname }}"
                                data-phone="{{ address.phone }}"
                                data-address="{{ address.address }}"
                                data-city="{{ address.city }}"
                                data-district="{{ address.district }}"
                                data-postal-code="{{ address.postal_code }}">
                          {{ address.title }} - {{ address.city }}
                        </option>
                      {% endfor %}
                    </select>
                  </div>
                  <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="save-new-address" name="save_new_address">
                    <label class="form-check-label" for="save-new-address">
                      Yeni adresi kaydet
                    </label>
                  </div>
                {% endif %}
              </div>
            </div>
          {% endif %}
          
          <div class="form-group mb-3">
            <label for="{{ form.fullname.id_for_label }}" class="form-label">Ad Soyad *</label>
            {{ form.fullname }}
            {% if form.fullname.errors %}
              <div class="text-danger small mt-1">
                {{ form.fullname.errors }}
              </div>
            {% endif %}
          </div>
          
          <div class="form-group mb-3">
            <label for="{{ form.email.id_for_label }}" class="form-label">E-posta *</label>
            {{ form.email }}
            {% if form.email.errors %}
              <div class="text-danger small mt-1">
                {{ form.email.errors }}
              </div>
            {% endif %}
          </div>
          
          <div class="form-group mb-3">
            <label for="{{ form.phone.id_for_label }}" class="form-label">Telefon</label>
            {{ form.phone }}
            {% if form.phone.errors %}
              <div class="text-danger small mt-1">
                {{ form.phone.errors }}
              </div>
            {% endif %}
          </div>
          
          <div class="form-group mb-3">
            <label for="{{ form.address.id_for_label }}" class="form-label">Adres *</label>
            {{ form.address }}
            {% if form.address.errors %}
              <div class="text-danger small mt-1">
                {{ form.address.errors }}
              </div>
            {% endif %}
          </div>
          
          <div class="row">
            <div class="col-md-6">
              <div class="form-group mb-3">
                <label for="{{ form.city.id_for_label }}" class="form-label">Şehir *</label>
                {{ form.city }}
                {% if form.city.errors %}
                  <div class="text-danger small mt-1">
                    {{ form.city.errors }}
                  </div>
                {% endif %}
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group mb-3">
                <label for="{{ form.postal_code.id_for_label }}" class="form-label">Posta Kodu *</label>
                {{ form.postal_code }}
                {% if form.postal_code.errors %}
                  <div class="text-danger small mt-1">
                    {{ form.postal_code.errors }}
                  </div>
                {% endif %}
              </div>
            </div>
          </div>
          
          <!-- Kargo Seçenekleri -->
          <div class="card mt-4">
            <div class="card-header">
              <h5 class="mb-0">Kargo Seçenekleri</h5>
            </div>
            <div class="card-body">
              <div class="form-group">
                <div class="form-check mb-2">
                  <input class="form-check-input" type="radio" name="shipping" id="shipping-standard" value="standard" checked>
                  <label class="form-check-label d-flex justify-content-between w-100" for="shipping-standard">
                    <span>
                      <strong>Standart Kargo</strong>
                      <br>
                      <small class="text-muted">3-5 iş günü</small>
                    </span>
                    <span class="shipping-price" data-price="{{ shipping_standard }}">{{ shipping_standard }} ₺</span>
                  </label>
                </div>
                <div class="form-check mb-2">
                  <input class="form-check-input" type="radio" name="shipping" id="shipping-express" value="express">
                  <label class="form-check-label d-flex justify-content-between w-100" for="shipping-express">
                    <span>
                      <strong>Hızlı Kargo</strong>
                      <br>
                      <small class="text-muted">1-2 iş günü</small>
                    </span>
                    <span class="shipping-price" data-price="{{ shipping_express }}">{{ shipping_express }} ₺</span>
                  </label>
                </div>
                <small class="text-info">{{ free_shipping_threshold }} ₺ ve üzeri siparişlerde kargo ücretsiz</small>
              </div>
            </div>
          </div>
          
          <!-- Fatura Bilgileri (Opsiyonel) -->
          <div class="card mt-4">
            <div class="card-header"><strong>Fatura Bilgileri (Opsiyonel)</strong></div>
            <div class="card-body">
              {% load form_extras %}
              
              {{ billing_form.non_field_errors }}
              
              <div class="form-check mb-3">
                {{ billing_form.want_invoice }} <label class="form-check-label" for="{{ billing_form.want_invoice.id_for_label }}">Fatura bilgisi girmek istiyorum</label>
              </div>
              
              <div class="row g-3" id="invoice-fields">
                <div class="col-md-4">
                  <label class="form-label">Fatura Tipi</label>
                  {{ billing_form.invoice_type|add_class:"form-select" }}
                </div>
                
                <div class="col-md-8">
                  <label class="form-label">Fatura Ad Soyad/Ünvan</label>
                  {{ billing_form.billing_fullname|add_class:"form-control" }}
                </div>
                
                <div id="row-tckn" class="col-md-4">
                  <label class="form-label">TCKN</label>
                  {{ billing_form.tckn|add_class:"form-control" }}
                </div>
                
                <div id="row-vkn" class="col-md-4">
                  <label class="form-label">VKN</label>
                  {{ billing_form.vkn|add_class:"form-control" }}
                </div>
                
                <div id="row-tax-office" class="col-md-4">
                  <label class="form-label">Vergi Dairesi</label>
                  {{ billing_form.tax_office|add_class:"form-control" }}
                </div>
                
                <div class="col-md-6">
                  <label class="form-label">E-Arşiv E-posta</label>
                  {{ billing_form.e_archive_email|add_class:"form-control" }}
                </div>
                
                <div class="col-12">
                  <label class="form-label">Fatura Adresi</label>
                  {{ billing_form.billing_address|add_class:"form-control" }}
                </div>
                
                <div class="col-md-4">
                  <label class="form-label">İl</label>
                  {{ billing_form.billing_city|add_class:"form-control" }}
                </div>
                
                <div class="col-md-4">
                  <label class="form-label">İlçe</label>
                  {{ billing_form.billing_district|add_class:"form-control" }}
                </div>
                
                <div class="col-md-4">
                  <label class="form-label">Posta Kodu</label>
                  {{ billing_form.billing_postcode|add_class:"form-control" }}
                </div>
                
                <div class="col-12">
                  <div class="form-check mt-2">
                    {{ billing_form.kvkk_approved }} <label class="form-check-label" for="{{ billing_form.kvkk_approved.id_for_label }}">KVKK Aydınlatma metnini okudum/onaylıyorum</label>
                  </div>
                </div>
              </div>
              
              <p class="text-muted small mt-2 mb-0">
                Not: Fatura bilgileri siparişe <strong>anlık kopya</strong> (snapshot) olarak kaydedilir.
              </p>
            </div>
          </div>
          
          <!-- Ödeme Yöntemi -->
          <div class="card mt-4">
            <div class="card-header">
              <h5 class="mb-0">Ödeme Yöntemi</h5>
            </div>
            <div class="card-body">
            </div>
          </div>
          
          <button type="submit" class="btn btn-success btn-lg w-100 mt-3">
            <i class="fas fa-credit-card me-2"></i>Siparişi Tamamla
          </button>
        </form>
      </div>
      <!-- Sağ: sipariş özeti -->
      <aside class="col-lg-5 sticky-summary">
      +        <aside class="mini-cart mb-4">
      +          <h6 class="mb-2">Mini Sepet Özeti</h6>
      +          {% with items=cart|default:cart_items %}
      +          {% if items %}
      +            {% for it in items %}
      +            <div class="mini-item">
      +              <div class="mini-thumb">
      +                <img src="{{ it.product.image.url|default:it.image.url }}" alt="{{ it.product.name|default:it.name }}" loading="lazy" width="64" height="64" decoding="async">
      +              </div>
      +              <div class="small">
      +                <div class="fw-bold">{{ it.product.name|default:it.name }}</div>
      +                <div class="text-muted">x{{ it.quantity|default:it.qty }}</div>
      +              </div>
      +              <div class="mini-line">₺ {{ it.total_price|default:it.line_total|floatformat:2|localize }}</div>
      +            </div>
      +            {% endfor %}
      +          {% else %}
      +            <p class="text-muted mb-0">Sepetiniz boş görünüyor.</p>
      +          {% endif %}
      +          {% endwith %}
      +        </aside>
       <div class="checkout-summary sticky-lg-top card-soft">
         <h2 class="h5 mb-3">Sipariş Özeti</h2>
         <div class="row-line"><span>Ara toplam</span><strong>₺ {{ cart_total_price|floatformat:2|localize }}</strong></div>
         {% if request.session.discount_amount %}
           <div class="row-line"><span>İndirim</span><strong class="text-success">-₺ {{ request.session.discount_amount|floatformat:2|localize }}</strong></div>
         {% endif %}
         {% if shipping_fee %}
           <div class="row-line"><span>Kargo</span><strong>₺ {{ shipping_fee|floatformat:2|localize }}</strong></div>
         {% endif %}
         <hr class="my-2">
         <div class="row-line total"><span>Genel Toplam</span><strong>₺ {{ total_amount|default:cart_total_price|floatformat:2|localize }}</strong></div>
         <button form="checkout-form" class="btn btn-brand w-100 mt-3" type="submit">Ödemeye Geç</button>
         <p class="small text-muted mt-2 mb-0">Ödemeye geç tuşuna basarak <a href="#kvkk">KVKK</a> ve <a href="#mesafeli">mesafeli satış</a> şartlarını kabul etmiş olursunuz.</p>
       </div>
       {% include "shop/_trust_badges.html" %}
     </aside>
    </div>
  </div>

  <script>
  document.addEventListener('DOMContentLoaded', function() {
      const addressSelect = document.getElementById('address-select');
      const shippingRadios = document.querySelectorAll('input[name="shipping"]');
      const subtotal = parseFloat('{{ cart_total|default:"0" }}');
      const freeShippingThreshold = parseFloat('{{ free_shipping_threshold|default:"500" }}');
      
      // Adres seçimi işlevi
      if (addressSelect) {
          addressSelect.addEventListener('change', function() {
              const selectedOption = this.options[this.selectedIndex];
              if (selectedOption.value) {
                  // Seçili adres bilgilerini formlara doldur
                  document.getElementById('{{ form.fullname.id_for_label }}').value = selectedOption.dataset.fullname || '';
                  document.getElementById('{{ form.phone.id_for_label }}').value = selectedOption.dataset.phone || '';
                  document.getElementById('{{ form.address.id_for_label }}').value = selectedOption.dataset.address || '';
                  document.getElementById('{{ form.city.id_for_label }}').value = selectedOption.dataset.city || '';
                  document.getElementById('{{ form.postal_code.id_for_label }}').value = selectedOption.dataset.postalCode || '';
              } else {
                  // Yeni adres seçildiğinde alanları temizle
                  document.getElementById('{{ form.fullname.id_for_label }}').value = '';
                  document.getElementById('{{ form.phone.id_for_label }}').value = '';
                  document.getElementById('{{ form.address.id_for_label }}').value = '';
                  document.getElementById('{{ form.city.id_for_label }}').value = '';
                  document.getElementById('{{ form.postal_code.id_for_label }}').value = '';
              }
          });
      }
      
      // Kargo ücreti hesaplama
      function updateShippingCost() {
          const selectedShipping = document.querySelector('input[name="shipping"]:checked');
          if (!selectedShipping) return;
          
          let shippingCost = 0;
          if (subtotal < freeShippingThreshold) {
              const shippingPrice = selectedShipping.closest('.form-check').querySelector('.shipping-price');
              shippingCost = parseFloat(shippingPrice.dataset.price) || 0;
          }
          
          const total = subtotal + shippingCost;
          
          // Toplamları güncelle
          document.getElementById('shipping-cost').textContent = shippingCost.toFixed(2) + ' ₺';
          document.getElementById('total-amount').textContent = total.toFixed(2) + ' ₺';
          
          // Ücretsiz kargo durumunda fiyatları güncelle
          document.querySelectorAll('.shipping-price').forEach(function(priceElement) {
              const originalPrice = parseFloat(priceElement.dataset.price);
              if (subtotal >= freeShippingThreshold) {
                  priceElement.textContent = 'Ücretsiz';
                  priceElement.classList.add('text-success');
              } else {
                  priceElement.textContent = originalPrice.toFixed(2) + ' ₺';
                  priceElement.classList.remove('text-success');
              }
          });
      }
      
      // Kargo seçimi değiştiğinde toplamları güncelle
      shippingRadios.forEach(function(radio) {
          radio.addEventListener('change', updateShippingCost);
      });
      
      // Sayfa yüklendiğinde ilk hesaplama
      updateShippingCost();
  });
  </script>
  <!-- Checkout JS (external, safe) -->
  <script src="{% static 'js/checkout.js' %}" defer></script>
{% endblock %}