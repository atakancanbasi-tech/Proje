{% extends 'shop/base.html' %}
{% load static %}

{% block title %}Yeni Şifre Belirle{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow">
                <div class="card-header bg-success text-white">
                    <h4 class="mb-0"><i class="fas fa-key"></i> Yeni Şifre Belirle</h4>
                </div>
                <div class="card-body">
                    {% if messages %}
                        {% for message in messages %}
                            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            </div>
                        {% endfor %}
                    {% endif %}

                    {% if validlink %}
                        <div class="text-center mb-4">
                            <i class="fas fa-shield-alt fa-3x text-success mb-3"></i>
                            <p class="text-muted">Güvenlik doğrulaması başarılı! Şimdi yeni şifrenizi belirleyebilirsiniz.</p>
                        </div>

                        <form method="post" id="passwordResetConfirmForm">
                            {% csrf_token %}
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="{{ form.new_password1.id_for_label }}" class="form-label">
                                            <i class="fas fa-key"></i> Yeni Şifre *
                                        </label>
                                        {{ form.new_password1 }}
                                        {% if form.new_password1.errors %}
                                            <div class="text-danger small mt-1">
                                                {% for error in form.new_password1.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                        <div class="password-strength mt-2">
                                            <div class="progress" style="height: 5px;">
                                                <div class="progress-bar" id="passwordStrength" role="progressbar" style="width: 0%"></div>
                                            </div>
                                            <small id="passwordStrengthText" class="form-text">Şifre gücü: Zayıf</small>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="{{ form.new_password2.id_for_label }}" class="form-label">
                                            <i class="fas fa-key"></i> Yeni Şifre Tekrar *
                                        </label>
                                        {{ form.new_password2 }}
                                        {% if form.new_password2.errors %}
                                            <div class="text-danger small mt-1">
                                                {% for error in form.new_password2.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                        <div id="passwordMatch" class="form-text mt-2"></div>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-4">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <h6><i class="fas fa-shield-alt"></i> Şifre Gereksinimleri:</h6>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <ul class="mb-0 small">
                                                    <li id="req-length">En az 8 karakter</li>
                                                    <li id="req-upper">En az 1 büyük harf</li>
                                                    <li id="req-lower">En az 1 küçük harf</li>
                                                </ul>
                                            </div>
                                            <div class="col-md-6">
                                                <ul class="mb-0 small">
                                                    <li id="req-number">En az 1 rakam</li>
                                                    <li id="req-special">En az 1 özel karakter</li>
                                                    <li id="req-common">Yaygın şifrelerden farklı</li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="d-grid mb-3">
                                <button type="submit" class="btn btn-success btn-lg" id="submitBtn">
                                    <i class="fas fa-save"></i> Yeni Şifreyi Kaydet
                                </button>
                            </div>
                        </form>
                    {% else %}
                        <div class="text-center">
                            <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
                            <h5 class="text-warning mb-3">Geçersiz veya Süresi Dolmuş Bağlantı</h5>
                            <p class="text-muted mb-4">
                                Bu şifre sıfırlama bağlantısı geçersiz veya süresi dolmuş. 
                                Lütfen yeni bir şifre sıfırlama isteği gönderin.
                            </p>
                            <a href="{% url 'security:password_reset_request' %}" class="btn btn-info">
                                <i class="fas fa-redo"></i> Yeni Sıfırlama İsteği
                            </a>
                        </div>
                    {% endif %}

                    <div class="text-center mt-4">
                        <hr>
                        <p class="mb-0">
                            <a href="{% url 'security:login' %}" class="text-decoration-none">
                                <i class="fas fa-arrow-left"></i> Giriş sayfasına dön
                            </a>
                        </p>
                    </div>
                </div>
                
                <div class="card-footer bg-light text-center">
                    <small class="text-muted">
                        <i class="fas fa-shield-alt text-success"></i>
                        Şifre değişikliği sonrası güvenlik bildirimi gönderilecektir
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const newPassword1 = document.getElementById('{{ form.new_password1.id_for_label }}');
    const newPassword2 = document.getElementById('{{ form.new_password2.id_for_label }}');
    const strengthBar = document.getElementById('passwordStrength');
    const strengthText = document.getElementById('passwordStrengthText');
    const passwordMatch = document.getElementById('passwordMatch');
    const submitBtn = document.getElementById('submitBtn');
    
    // Yaygın şifreler listesi (basit kontrol için)
    const commonPasswords = [
        'password', '123456', '123456789', 'qwerty', 'abc123', 
        'password123', 'admin', 'letmein', 'welcome', 'monkey',
        'şifre', 'parola', '123456', 'qwerty123'
    ];
    
    // Şifre gücü kontrolü
    function checkPasswordStrength(password) {
        let score = 0;
        
        // Uzunluk kontrolü
        const lengthReq = document.getElementById('req-length');
        if (password.length >= 8) {
            score += 15;
            lengthReq.className = 'text-success';
            lengthReq.innerHTML = '<i class="fas fa-check"></i> En az 8 karakter';
        } else {
            lengthReq.className = 'text-danger';
            lengthReq.innerHTML = '<i class="fas fa-times"></i> En az 8 karakter';
        }
        
        // Büyük harf kontrolü
        const upperReq = document.getElementById('req-upper');
        if (/[A-Z]/.test(password)) {
            score += 15;
            upperReq.className = 'text-success';
            upperReq.innerHTML = '<i class="fas fa-check"></i> En az 1 büyük harf';
        } else {
            upperReq.className = 'text-danger';
            upperReq.innerHTML = '<i class="fas fa-times"></i> En az 1 büyük harf';
        }
        
        // Küçük harf kontrolü
        const lowerReq = document.getElementById('req-lower');
        if (/[a-z]/.test(password)) {
            score += 15;
            lowerReq.className = 'text-success';
            lowerReq.innerHTML = '<i class="fas fa-check"></i> En az 1 küçük harf';
        } else {
            lowerReq.className = 'text-danger';
            lowerReq.innerHTML = '<i class="fas fa-times"></i> En az 1 küçük harf';
        }
        
        // Rakam kontrolü
        const numberReq = document.getElementById('req-number');
        if (/[0-9]/.test(password)) {
            score += 15;
            numberReq.className = 'text-success';
            numberReq.innerHTML = '<i class="fas fa-check"></i> En az 1 rakam';
        } else {
            numberReq.className = 'text-danger';
            numberReq.innerHTML = '<i class="fas fa-times"></i> En az 1 rakam';
        }
        
        // Özel karakter kontrolü
        const specialReq = document.getElementById('req-special');
        if (/[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password)) {
            score += 15;
            specialReq.className = 'text-success';
            specialReq.innerHTML = '<i class="fas fa-check"></i> En az 1 özel karakter';
        } else {
            specialReq.className = 'text-danger';
            specialReq.innerHTML = '<i class="fas fa-times"></i> En az 1 özel karakter';
        }
        
        // Yaygın şifre kontrolü
        const commonReq = document.getElementById('req-common');
        if (!commonPasswords.includes(password.toLowerCase()) && password.length > 0) {
            score += 25;
            commonReq.className = 'text-success';
            commonReq.innerHTML = '<i class="fas fa-check"></i> Yaygın şifrelerden farklı';
        } else if (commonPasswords.includes(password.toLowerCase())) {
            commonReq.className = 'text-danger';
            commonReq.innerHTML = '<i class="fas fa-times"></i> Bu şifre çok yaygın';
        } else {
            commonReq.className = 'text-muted';
            commonReq.innerHTML = '<i class="fas fa-minus"></i> Yaygın şifrelerden farklı';
        }
        
        // Güç göstergesi güncelle
        strengthBar.style.width = score + '%';
        
        if (score < 30) {
            strengthBar.className = 'progress-bar bg-danger';
            strengthText.textContent = 'Şifre gücü: Çok Zayıf';
            strengthText.className = 'form-text text-danger';
        } else if (score < 50) {
            strengthBar.className = 'progress-bar bg-warning';
            strengthText.textContent = 'Şifre gücü: Zayıf';
            strengthText.className = 'form-text text-warning';
        } else if (score < 70) {
            strengthBar.className = 'progress-bar bg-info';
            strengthText.textContent = 'Şifre gücü: Orta';
            strengthText.className = 'form-text text-info';
        } else if (score < 90) {
            strengthBar.className = 'progress-bar bg-primary';
            strengthText.textContent = 'Şifre gücü: Güçlü';
            strengthText.className = 'form-text text-primary';
        } else {
            strengthBar.className = 'progress-bar bg-success';
            strengthText.textContent = 'Şifre gücü: Çok Güçlü';
            strengthText.className = 'form-text text-success';
        }
        
        return score;
    }
    
    // Şifre eşleşme kontrolü
    function checkPasswordMatch() {
        if (newPassword2.value === '') {
            passwordMatch.textContent = '';
            return;
        }
        
        if (newPassword1.value === newPassword2.value) {
            passwordMatch.innerHTML = '<i class="fas fa-check text-success"></i> Şifreler eşleşiyor';
            passwordMatch.className = 'form-text text-success';
        } else {
            passwordMatch.innerHTML = '<i class="fas fa-times text-danger"></i> Şifreler eşleşmiyor';
            passwordMatch.className = 'form-text text-danger';
        }
    }
    
    // Event listener'lar
    if (newPassword1) {
        newPassword1.addEventListener('input', function() {
            checkPasswordStrength(this.value);
            checkPasswordMatch();
        });
    }
    
    if (newPassword2) {
        newPassword2.addEventListener('input', checkPasswordMatch);
    }
    
    // Form gönderme kontrolü
    const form = document.getElementById('passwordResetConfirmForm');
    if (form) {
        form.addEventListener('submit', function(e) {
            const score = checkPasswordStrength(newPassword1.value);
            
            if (score < 60) {
                e.preventDefault();
                alert('Lütfen daha güçlü bir şifre seçin.');
                return false;
            }
            
            if (newPassword1.value !== newPassword2.value) {
                e.preventDefault();
                alert('Yeni şifreler eşleşmiyor.');
                return false;
            }
            
            // Buton durumunu değiştir
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Kaydediliyor...';
        });
    }
});
</script>

<style>
.card {
    border: none;
    border-radius: 15px;
}

.card-header {
    border-radius: 15px 15px 0 0 !important;
}

.card-footer {
    border-radius: 0 0 15px 15px !important;
}

.form-control {
    border-radius: 10px;
    border: 2px solid #e9ecef;
    transition: all 0.3s ease;
}

.form-control:focus {
    border-color: #28a745;
    box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
}

.btn {
    border-radius: 10px;
    padding: 12px 20px;
    font-weight: 600;
    transition: all 0.3s ease;
}

.btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}

.alert {
    border-radius: 10px;
}

.shadow {
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15) !important;
}

.progress {
    border-radius: 10px;
}

.card.bg-light {
    border-radius: 10px;
}

a {
    transition: all 0.3s ease;
}

a:hover {
    transform: translateX(5px);
}

.fa-3x {
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% {
        transform: scale(1);
    }
    50% {
        transform: scale(1.1);
    }
    100% {
        transform: scale(1);
    }
}
</style>
{% endblock %}