{% load static money i18n humanize %}
<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  
  <!-- Meta Tags for SEO -->
  <title>{% block title %}Satış Sitesi{% endblock %}</title>
  <meta name="description" content="{% block description %}Modern e-ticaret platformu ile güvenli alışveriş deneyimi.{% endblock %}" />
  <meta name="keywords" content="{% block keywords %}e-ticaret, alışveriş, ürün, online{% endblock %}" />
  
  <!-- Open Graph Meta Tags -->
  <meta property="og:locale" content="tr_TR" />
  <meta property="og:type" content="website" />
  <meta property="og:title" content="{% block og_title %}Satış Sitesi{% endblock %}" />
  <meta property="og:description" content="{% block og_description %}Modern e-ticaret platformu ile güvenli alışveriş deneyimi.{% endblock %}" />
  
  <!-- Favicon -->
  <link rel="icon" type="image/x-icon" href="{% static 'images/favicon.ico' %}" />
  
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
  
  <!-- Font Awesome Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous">
  
  <!-- Custom CSS -->
  <link rel="stylesheet" href="{% static 'css/main.css' %}">
  <link rel="stylesheet" href="{% static 'css/theme.css' %}?v={{ cache_bust }}">
  
  {% block extra_css %}{% endblock %}
</head>
<body>
  <!-- Skip Links for Accessibility -->
  <div class="skip-links">
    <a href="#main-content" class="visually-hidden-focusable btn btn-primary position-absolute top-0 start-0 m-2 z-index-1050">Ana içeriğe geç</a>
    <a href="#navbar-main" class="visually-hidden-focusable btn btn-primary position-absolute top-0 start-0 m-2 z-index-1050" style="top: 3rem !important;">Navigasyona geç</a>
    <a href="#footer" class="visually-hidden-focusable btn btn-primary position-absolute top-0 start-0 m-2 z-index-1050" style="top: 6rem !important;">Footer'a geç</a>
  </div>
  
  <!-- Header -->
  {% include "shop/partials/header.html" %}
          

  
  <!-- Main Content -->
  <main id="main-content" class="container my-4" role="main">
    <!-- Loading Spinner (Hidden by default) -->
    <div id="loading-spinner" class="text-center py-5 d-none" role="status" aria-label="Yükleniyor">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Yükleniyor...</span>
      </div>
      <p class="mt-2 text-muted">Lütfen bekleyin...</p>
    </div>
    
    <!-- Messages -->
    {% if messages %}
      <div class="mb-4" role="region" aria-label="Sistem mesajları">
        {% for message in messages %}
          <div class="alert alert-{{ message.tags|default:'info' }} alert-dismissible fade show" role="alert" aria-live="polite" aria-atomic="true">
            {% if message.tags == 'error' %}
              <i class="fas fa-exclamation-circle me-2" aria-hidden="true"></i>
              <span class="visually-hidden">Hata: </span>
            {% elif message.tags == 'warning' %}
              <i class="fas fa-exclamation-triangle me-2" aria-hidden="true"></i>
              <span class="visually-hidden">Uyarı: </span>
            {% elif message.tags == 'success' %}
              <i class="fas fa-check-circle me-2" aria-hidden="true"></i>
              <span class="visually-hidden">Başarılı: </span>
            {% else %}
              <i class="fas fa-info-circle me-2" aria-hidden="true"></i>
              <span class="visually-hidden">Bilgi: </span>
            {% endif %}
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Bu mesajı kapat"></button>
          </div>
        {% endfor %}
      </div>
    {% endif %}
    
    <!-- Page Content -->
    {% block content %}{% endblock %}
  </main>
  
  <!-- Footer -->
  {% include "shop/partials/footer.html" %}
  
  <!-- Scripts -->
  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js" crossorigin="anonymous"></script>
  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
  
  <!-- Custom Scripts -->
  <script>
  $(document).ready(function() {
      let mainAutocompleteTimeout;
      
      // Ana arama autocomplete
      $('#main-search').on('input', function() {
          const query = $(this).val().trim();
          const $suggestions = $('#main-autocomplete-suggestions');
          
          clearTimeout(mainAutocompleteTimeout);
          
          if (query.length < 2) {
              $suggestions.hide().empty();
              return;
          }
          
          mainAutocompleteTimeout = setTimeout(function() {
              $.ajax({
                  url: '{% url "shop:search_autocomplete" %}',
                  data: { q: query },
                  success: function(data) {
                      $suggestions.empty();
                      
                      if (data.suggestions && data.suggestions.length > 0) {
                          data.suggestions.forEach(function(suggestion, index) {
                              const $item = $('<div class="p-2 border-bottom autocomplete-item" role="option" tabindex="-1"></div>')
                                  .text(suggestion)
                                  .on('click', function() {
                                      $('#main-search').val(suggestion);
                                      $suggestions.hide();
                                      $(this).closest('form').submit();
                                  })
                                  .on('mouseenter', function() {
                                      $(this).addClass('bg-light');
                                  })
                                  .on('mouseleave', function() {
                                      $(this).removeClass('bg-light');
                                  });
                              $suggestions.append($item);
                          });
                          $suggestions.show();
                      } else {
                          $suggestions.hide();
                      }
                  },
                  error: function() {
                      $suggestions.hide();
                  }
              });
          }, 300);
      });
      
      // Klavye navigasyonu
      $('#main-search').on('keydown', function(e) {
          const $suggestions = $('#main-autocomplete-suggestions');
          const $items = $suggestions.find('.autocomplete-item');
          const $active = $items.filter('.bg-light');
          
          if (e.key === 'ArrowDown') {
              e.preventDefault();
              if ($active.length === 0) {
                  $items.first().addClass('bg-light');
              } else {
                  $active.removeClass('bg-light');
                  const $next = $active.next();
                  if ($next.length) {
                      $next.addClass('bg-light');
                  } else {
                      $items.first().addClass('bg-light');
                  }
              }
          } else if (e.key === 'ArrowUp') {
              e.preventDefault();
              if ($active.length === 0) {
                  $items.last().addClass('bg-light');
              } else {
                  $active.removeClass('bg-light');
                  const $prev = $active.prev();
                  if ($prev.length) {
                      $prev.addClass('bg-light');
                  } else {
                      $items.last().addClass('bg-light');
                  }
              }
          } else if (e.key === 'Enter' && $active.length) {
              e.preventDefault();
              $active.click();
          } else if (e.key === 'Escape') {
              $suggestions.hide();
          }
      });
      
      // Ana arama autocomplete gizleme
      $(document).on('click', function(e) {
          if (!$(e.target).closest('.position-relative').length) {
              $('#main-autocomplete-suggestions').hide();
          }
      });
      
      // Enhanced Loading state helpers
      window.showLoading = function() {
          $('#loading-spinner').removeClass('d-none');
      };
      
      window.hideLoading = function() {
          $('#loading-spinner').addClass('d-none');
      };
      
      // Global loading overlay functions
      window.showLoadingOverlay = function(message = 'Yükleniyor...') {
          let overlay = document.getElementById('global-loading-overlay');
          if (!overlay) {
              overlay = document.createElement('div');
              overlay.id = 'global-loading-overlay';
              overlay.className = 'loading-overlay';
              overlay.setAttribute('role', 'status');
              overlay.setAttribute('aria-live', 'polite');
              overlay.innerHTML = `
                  <div class="text-center">
                      <div class="loading-spinner loading-spinner-lg" aria-hidden="true"></div>
                      <p class="mt-3 mb-0">${message}</p>
                      <span class="visually-hidden">İçerik yükleniyor, lütfen bekleyin</span>
                  </div>
              `;
              document.body.appendChild(overlay);
          }
          overlay.style.display = 'flex';
          document.body.style.overflow = 'hidden';
      };
      
      window.hideLoadingOverlay = function() {
          const overlay = document.getElementById('global-loading-overlay');
          if (overlay) {
              overlay.style.display = 'none';
              document.body.style.overflow = '';
          }
      };
      
      // Skeleton loading helper
      window.showSkeletonLoading = function(container, type = 'product', count = 3) {
          if (!container) return;
          
          const skeletonHTML = {
              product: `
                  <div class="skeleton-card">
                      <div class="skeleton skeleton-image"></div>
                      <div class="skeleton skeleton-title"></div>
                      <div class="skeleton skeleton-text"></div>
                      <div class="skeleton skeleton-text"></div>
                      <div class="skeleton skeleton-text"></div>
                  </div>
              `,
              order: `
                  <div class="skeleton-card">
                      <div class="row">
                          <div class="col-md-3">
                              <div class="skeleton skeleton-image" style="height: 100px;"></div>
                          </div>
                          <div class="col-md-9">
                              <div class="skeleton skeleton-title"></div>
                              <div class="skeleton skeleton-text"></div>
                              <div class="skeleton skeleton-text"></div>
                          </div>
                      </div>
                  </div>
              `
          };
          
          let html = '';
          for (let i = 0; i < count; i++) {
              html += skeletonHTML[type] || skeletonHTML.product;
          }
          
          if (typeof container === 'string') {
              container = document.querySelector(container);
          }
          
          if (container) {
              container.innerHTML = html;
          }
      };
      
      // AJAX form submission with loading states
      window.submitFormWithLoading = function(form, options = {}) {
          const $form = $(form);
          const originalText = $form.find('button[type="submit"]').html();
          
          // Show loading state
          $form.find('button[type="submit"]')
              .prop('disabled', true)
              .html('<span class="loading-spinner loading-spinner-sm me-2"></span>Gönderiliyor...');
          
          if (options.showOverlay) {
              showLoadingOverlay(options.loadingMessage);
          }
          
          return $.ajax({
              url: $form.attr('action') || window.location.href,
              method: $form.attr('method') || 'POST',
              data: $form.serialize(),
              ...options.ajaxOptions
          }).always(function() {
              // Reset form state
              $form.find('button[type="submit"]')
                  .prop('disabled', false)
                  .html(originalText);
              
              if (options.showOverlay) {
                  hideLoadingOverlay();
              }
          });
      };
      
      // Auto-hide alerts after 5 seconds
      $('.alert:not(.alert-permanent)').each(function() {
          const $alert = $(this);
          setTimeout(function() {
              $alert.fadeOut(500, function() {
                  $(this).remove();
              });
          }, 5000);
      });
  });
  </script>
  
  {% block extra_js %}{% endblock %}
</body>
</html>